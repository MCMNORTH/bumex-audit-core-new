rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Project engagement structures - only accessible by project team members
    match /engagement-structures/{projectId}/{allPaths=**} {
      allow read, write: if request.auth != null 
        && exists(/databases/(default)/documents/users/$(request.auth.uid))
        && get(/databases/(default)/documents/users/$(request.auth.uid)).data.approved == true
        && get(/databases/(default)/documents/users/$(request.auth.uid)).data.blocked != true
        && (
          // Dev, admin, semi-admin can access all project files
          get(/databases/(default)/documents/users/$(request.auth.uid)).data.role in ["dev", "admin", "semi-admin"] ||
          // Team members can access their project files
          (exists(/databases/(default)/documents/projects/$(projectId)) &&
           request.auth.uid in get(/databases/(default)/documents/projects/$(projectId)).data.member_ids)
        );
    }
    
    // User profile images
    match /user-profiles/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null 
        && (request.auth.uid == userId ||
            (exists(/databases/(default)/documents/users/$(request.auth.uid)) &&
             get(/databases/(default)/documents/users/$(request.auth.uid)).data.role in ["dev", "admin"]));
    }
    
    // General uploads - restrict to authenticated approved users
    match /{allPaths=**} {
      allow read, write: if request.auth != null 
        && exists(/databases/(default)/documents/users/$(request.auth.uid))
        && get(/databases/(default)/documents/users/$(request.auth.uid)).data.approved == true
        && get(/databases/(default)/documents/users/$(request.auth.uid)).data.blocked != true;
    }
  }
}